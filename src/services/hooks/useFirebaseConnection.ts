/**
 * @description Hook pro spr√°vu Firebase p≈ôipojen√≠ a synchronizace
 * Zjednodu≈°en√° verze bez autentizace
 */

import { useState, useEffect } from 'react';
import { syncService } from '../storage/syncService';
import { getCurrentUserId } from '../firebase/auth';

/**
 * @description Hook pro spr√°vu Firebase p≈ôipojen√≠ (bez autentizace)
 */
export const useFirebaseConnection = () => {
  const [isSyncing, setIsSyncing] = useState(false);
  const [syncError, setSyncError] = useState<string | null>(null);
  const [lastSyncAt, setLastSyncAt] = useState<Date | null>(null);

  // Automatick√° synchronizace p≈ôi startu (bez autentizace)
  useEffect(() => {
    const userId = getCurrentUserId();
    if (userId && !isSyncing) {
      // Nejprve st√°hni data z Firebase, pak synchronizuj
      stahniAPotemSynchronizuj();
    }
  }, []);

  /**
   * @description St√°hne data z Firebase a pak synchronizuje
   */
  const stahniAPotemSynchronizuj = async () => {
    const userId = getCurrentUserId();
    if (!userId) {
      setSyncError('Chyba: userId nen√≠ dostupn√©');
      return;
    }

    try {
      setIsSyncing(true);
      setSyncError(null);
      
      console.log('üîÑ Stahov√°n√≠ dat z Firebase...');
      await syncService.stahniDataZFirebase();
      
      console.log('üîÑ Synchronizace lok√°ln√≠ch zmƒõn...');
      await syncService.synchronizujVsechnyZaznamy();
      
      setLastSyncAt(new Date());
      console.log('‚úÖ Kompletn√≠ synchronizace dokonƒçena');
    } catch (error: any) {
      const errorMessage = error?.message || 'Nezn√°m√° chyba p≈ôi synchronizaci';
      setSyncError(errorMessage);
      console.error('‚ùå Chyba p≈ôi kompletn√≠ synchronizaci:', error);
    } finally {
      setIsSyncing(false);
    }
  };

  /**
   * @description Manu√°ln√≠ synchronizace dat
   */
  const synchronizujData = async () => {
    const userId = getCurrentUserId();
    if (!userId) {
      setSyncError('Chyba: userId nen√≠ dostupn√©');
      return;
    }

    try {
      setIsSyncing(true);
      setSyncError(null);
      
      await syncService.synchronizujVsechnyZaznamy();
      
      setLastSyncAt(new Date());
      console.log('Synchronizace dokonƒçena');
    } catch (error: any) {
      const errorMessage = error?.message || 'Nezn√°m√° chyba p≈ôi synchronizaci';
      setSyncError(errorMessage);
      console.error('Chyba p≈ôi synchronizaci:', error);
    } finally {
      setIsSyncing(false);
    }
  };

  /**
   * @description Z√≠sk√°n√≠ statistik synchronizace
   */
  const getStatistiky = async () => {
    try {
      return await syncService.getStatistikySynchronizace();
    } catch (error) {
      console.error('Chyba p≈ôi z√≠sk√°v√°n√≠ statistik:', error);
      return null;
    }
  };

  return {
    // Zjednodu≈°en√Ω stav (bez autentizace)
    userId: getCurrentUserId(),
    isAuthenticated: true, // V≈ædy "p≈ôihl√°≈°en"
    isAuthLoading: false,
    authError: null,

    // Sync stav
    isSyncing,
    syncError,
    lastSyncAt,

    // Akce
    synchronizujData,
    getStatistiky,

    // Utility
    isOnline: true, // V≈ædy online (bez auth kontrol)
    canSync: !isSyncing
  };
};
